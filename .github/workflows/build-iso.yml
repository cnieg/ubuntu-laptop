name: Build Ubuntu Custom ISO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
    
    - name: Make build script executable
      run: chmod +x scripts/build-iso.sh
    
    - name: Build ISO
      run: ./scripts/build-iso.sh
    
    - name: Generate checksum
      run: |
        cd $HOME/iso-build
        sha256sum ubuntu-25.10-desktop-custom.iso > ubuntu-25.10-desktop-custom.iso.sha256
        cat ubuntu-25.10-desktop-custom.iso.sha256
    
    - name: Prepare Ventoy package
      run: |
        cd $HOME
        mkdir -p ventoy-package
        
        # Copier l'ISO
        cp iso-build/ubuntu-25.10-desktop-custom.iso ventoy-package/
        cp iso-build/ubuntu-25.10-desktop-custom.iso.sha256 ventoy-package/
        
        # Créer la structure Ventoy
        mkdir -p ventoy-package/ventoy/ubuntu-autoinstall
        
        # Copier les fichiers cloud-init depuis le repo
        cp $GITHUB_WORKSPACE/ventoy/ubuntu-autoinstall/user-data ventoy-package/ventoy/ubuntu-autoinstall/
        cp $GITHUB_WORKSPACE/ventoy/ubuntu-autoinstall/meta-data ventoy-package/ventoy/ubuntu-autoinstall/
        cp $GITHUB_WORKSPACE/ventoy/ventoy.json ventoy-package/ventoy/
        
        # Copier le logo si présent
        if [ -f "$GITHUB_WORKSPACE/assets/oasis-logo.png" ]; then
          cp $GITHUB_WORKSPACE/assets/oasis-logo.png ventoy-package/ventoy/ubuntu-autoinstall/
        fi
        
        # Créer un README pour Ventoy
        cat > ventoy-package/README-VENTOY.txt << 'VENTOYREADME'
        Ubuntu Laptop - Package Ventoy
        ===============================
        
        Ce package contient tout le nécessaire pour booter l'ISO sur Ventoy.
        
        Installation sur clé Ventoy:
        ----------------------------
        1. Montez votre clé Ventoy
        2. Copiez ubuntu-25.10-desktop-custom.iso à la racine de Ventoy
        3. Copiez le dossier "ventoy/" à la racine de Ventoy (fusionnez si existe déjà)
        
        Structure finale sur votre clé:
        /
        ├── ubuntu-25.10-desktop-custom.iso
        └── ventoy/
            ├── ventoy.json
            └── ubuntu-autoinstall/
                ├── user-data
                ├── meta-data
                └── oasis-logo.png
        
        Configuration:
        --------------
        - Hostname: ubuntu-laptop
        - Username: ubuntu-admin
        - Clavier: FR
        - Locale: fr_FR.UTF-8
        - Stockage: LUKS + btrfs
        - Desktop: GNOME (Wayland)
        
        L'installation démarre automatiquement après 1 seconde.
        VENTOYREADME
        
        # Afficher la structure
        echo "Structure du package Ventoy:"
        tree ventoy-package || find ventoy-package -type f
    
    - name: Create Ventoy archive
      run: |
        cd $HOME
        tar czf ventoy-package.tar.gz ventoy-package/
        ls -lh ventoy-package.tar.gz
    
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: ubuntu-25.10-desktop-custom-iso
        path: |
          ~/iso-build/ubuntu-25.10-desktop-custom.iso
          ~/iso-build/ubuntu-25.10-desktop-custom.iso.sha256
        retention-days: 30
    
    - name: Upload Ventoy package
      uses: actions/upload-artifact@v4
      with:
        name: ventoy-package
        path: ~/ventoy-package.tar.gz
        retention-days: 30
    
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ~/iso-build/ubuntu-25.10-desktop-custom.iso
          ~/iso-build/ubuntu-25.10-desktop-custom.iso.sha256
          ~/ventoy-package.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
